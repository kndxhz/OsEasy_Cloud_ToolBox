name: Build and Release

on:  
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:   
  build-and-release:  
    runs-on: windows-latest
    
    steps:  
    - name: Checkout code
      uses: actions/checkout@v4
      with:  
        fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²ä»¥ä¾¿ç”Ÿæˆå˜æ›´æ—¥å¿—
    
    - name:  Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
    
    - name: Read version from AssemblyInfo.cs
      id: read-version
      shell: pwsh
      run: |
        $assemblyInfoPath = Get-ChildItem -Path .  -Filter "AssemblyInfo.cs" -Recurse | Select-Object -First 1
        if ($assemblyInfoPath) {
          $content = Get-Content -LiteralPath $assemblyInfoPath. FullName -Raw
          if ($content -match 'AssemblyVersion\("([^"]+)"\)') {
            $version = $matches[1]
            "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            echo "Found version:  $version"
          } else {
            echo "Error: Could not find AssemblyVersion in $($assemblyInfoPath. FullName)"
            exit 1
          }
        } else {
          echo "Error: AssemblyInfo.cs not found"
          exit 1
        }
    
    - name: Get previous tag
      id: get-prev-tag
      shell:  pwsh
      run: |
        $tags = git tag --sort=-version:refname
        if ($tags) {
          $prevTag = ($tags | Select-Object -First 1)
          "PREV_TAG=$prevTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "Previous tag: $prevTag"
        } else {
          "PREV_TAG=" | Out-File -FilePath $env: GITHUB_OUTPUT -Encoding utf8 -Append
          echo "No previous tags found"
        }
    
    - name: Generate changelog
      id:  changelog
      shell:  pwsh
      run: |
        $prevTag = "${{ steps.get-prev-tag. outputs.PREV_TAG }}"
        $version = "v${{ steps.read-version.outputs. VERSION }}"
        
        # ç”Ÿæˆ Full Changelog é“¾æ¥
        if ($prevTag) {
          $fullChangelog = "Full Changelog: $prevTag...$version"
        } else {
          $fullChangelog = "Full Changelog: Initial Release $version"
        }
        
        # è·å–æäº¤ä¿¡æ¯
        $commits = if ($prevTag) {
          git log "$prevTag..HEAD" --pretty=format:"%s (%h)" --no-merges
        } else {
          git log --pretty=format:"%s (%h)" --no-merges
        }
        
        # åˆ†ç±»æäº¤
        $featCommits = @()
        $fixCommits = @()
        $otherCommits = @()
        
        foreach ($commit in $commits) {
          if ($commit -match "^feat(\(.+?\))?:\s*(.+)") {
            $featCommits += $commit
          } elseif ($commit -match "^fix(\(. +?\))?:\s*(.+)") {
            $fixCommits += $commit
          } else {
            $otherCommits += $commit
          }
        }
        
        # æ„å»º changelog æ–‡æœ¬
        $changelog = @()
        $changelog += "# Changelog $version"
        $changelog += $fullChangelog
        if ($featCommits.Count -gt 0) {
          $changelog += "`n## âœ¨ Features"
          $changelog += $featCommits
        }
        if ($fixCommits.Count -gt 0) {
          $changelog += "`n## ğŸ› Fixes"
          $changelog += $fixCommits
        }
        if ($otherCommits.Count -gt 0) {
          $changelog += "`n## ğŸ“¦ Others"
          $changelog += $otherCommits
        }
        
        $changelogText = $changelog -join "`n"
        
        # ä½¿ç”¨éšæœºåˆ†éš”ç¬¦å¤„ç†å¤šè¡Œè¾“å‡º
        $delimiter = [System.Guid]::NewGuid().ToString()
        "CHANGELOG<<$delimiter" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        $changelogText | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        $delimiter | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
        echo "Generated changelog:"
        echo $changelogText
    
    - name:  Restore NuGet packages
      run: nuget restore
    
    - name:  Build solution
      run: msbuild /p: Configuration=Release /p:Platform="Any CPU"
    
    - name:  Create Release
      uses: softprops/action-gh-release@v2
      with: 
        tag_name: v${{ steps.read-version.outputs. VERSION }}
        name: Release v${{ steps.read-version.outputs. VERSION }}
        body: ${{ steps.changelog. outputs. CHANGELOG }}
        draft: false
        prerelease: false
        files: |
          **/bin/Release/*. exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
